name: Pylint and Tests

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.8", "3.9", "3.10"]
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v3
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install Poetry
      run: |
        curl -sSL https://install.python-poetry.org | python3 -
        echo "$HOME/.local/bin" >> $GITHUB_PATH

    - name: Run pylint and tests on all microservices
      run: |
        # Process each microservice in services directory
        for service in services/*/; do
          if [ -f "$service/pyproject.toml" ]; then
            echo "=== Processing: $(basename $service) ==="
            cd "$service"
            
            # Install dependencies with Poetry
            poetry install --no-root
            
            # Run pylint first
            echo "Running pylint..."
            poetry run pylint $(find . -name "*.py") --disable=R0801 --fail-under=6.0 || true
            
            # Then run pytest
            echo "Running tests..."
            poetry run pytest -v || echo "Tests failed or no tests found"
            
            cd - > /dev/null
            echo
          fi
        done
        
        # Process shared-lib if it exists
        if [ -f "shared-lib/pyproject.toml" ]; then
          echo "=== Processing shared-lib ==="
          cd shared-lib
          poetry install --no-root
          poetry run pylint $(find . -name "*.py") --disable=R0801 --fail-under=6.0 || true
          poetry run pytest -v || echo "Tests failed or no tests found"
          cd - > /dev/null
        fi